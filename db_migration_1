BEGIN TRANSACTION;
GO

ALTER TABLE [InvoiceItem] DROP CONSTRAINT [FK_InvoiceItem_Invoices_InvoiceId];
GO

ALTER TABLE [Invoices] DROP CONSTRAINT [PK_Invoices];
GO

DECLARE @var0 sysname;
SELECT @var0 = [d].[name]
FROM [sys].[default_constraints] [d]
INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
WHERE ([d].[parent_object_id] = OBJECT_ID(N'[Invoices]') AND [c].[name] = N'TypeId');
IF @var0 IS NOT NULL EXEC(N'ALTER TABLE [Invoices] DROP CONSTRAINT [' + @var0 + '];');
ALTER TABLE [Invoices] DROP COLUMN [TypeId];
GO

EXEC sp_rename N'[Invoices]', N'SalesDocuments';
GO

EXEC sp_rename N'[InvoiceItem].[UnitOfMeasure]', N'UnitOfMeasureCode', N'COLUMN';
GO

ALTER TABLE [InvoiceItem] ADD [AmountWithVat] decimal(18,2) NULL;
GO

ALTER TABLE [Address] ADD [CountryCode] nvarchar(max) NOT NULL DEFAULT N'';
GO

ALTER TABLE [SalesDocuments] ADD [ParentId] int NULL;
GO

ALTER TABLE [SalesDocuments] ADD [TypeCode] nvarchar(max) NOT NULL DEFAULT N'';
GO

ALTER TABLE [SalesDocuments] ADD CONSTRAINT [PK_SalesDocuments] PRIMARY KEY ([Id]);
GO

ALTER TABLE [InvoiceItem] ADD CONSTRAINT [FK_InvoiceItem_SalesDocuments_InvoiceId] FOREIGN KEY ([InvoiceId]) REFERENCES [SalesDocuments] ([Id]) ON DELETE CASCADE;
GO

INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
VALUES (N'20230118114401_ReplaceSalesDocumentIdsWithCodes', N'7.0.0');
GO

COMMIT;
GO

BEGIN TRANSACTION;
GO

DROP TABLE [InvoiceItem];
GO

ALTER TABLE [SalesDocuments] ADD [TotalAmountWithVat] decimal(18,2) NULL;
GO

ALTER TABLE [SalesDocuments] ADD [TotalAmountWithoutVat] decimal(18,2) NULL;
GO

ALTER TABLE [SalesDocuments] ADD [TotalVatAmount] decimal(18,2) NULL;
GO

CREATE TABLE [SalesDocumentItem] (
    [Id] int NOT NULL IDENTITY,
    [SalesDocumentId] int NOT NULL,
    [LineNumber] int NOT NULL,
    [ItemNumber] nvarchar(max) NULL,
    [Description] nvarchar(max) NULL,
    [UnitOfMeasureCode] nvarchar(max) NULL,
    [Quantity] int NOT NULL,
    [UnitPrice] decimal(18,2) NOT NULL,
    [Discount] decimal(18,2) NULL,
    [Account] nvarchar(max) NULL,
    [TaxRate] decimal(18,2) NULL,
    [VatAmount] decimal(18,2) NULL,
    [AmountWithoutVat] decimal(18,2) NULL,
    [AmountWithVat] decimal(18,2) NULL,
    CONSTRAINT [PK_SalesDocumentItem] PRIMARY KEY ([Id]),
    CONSTRAINT [FK_SalesDocumentItem_SalesDocuments_SalesDocumentId] FOREIGN KEY ([SalesDocumentId]) REFERENCES [SalesDocuments] ([Id]) ON DELETE CASCADE
);
GO

CREATE INDEX [IX_SalesDocumentItem_SalesDocumentId] ON [SalesDocumentItem] ([SalesDocumentId]);
GO

INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
VALUES (N'20230118130358_RenameInvoicesToSalesDocuments', N'7.0.0');
GO

COMMIT;
GO

BEGIN TRANSACTION;
GO

ALTER TABLE [SalesDocuments] ADD [Notes] nvarchar(max) NULL;
GO

ALTER TABLE [SalesDocuments] ADD [Recipient] nvarchar(max) NOT NULL DEFAULT N'';
GO

INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
VALUES (N'20230125120831_AddRecipientAndNotesToSalesDocuments', N'7.0.0');
GO

COMMIT;
GO

BEGIN TRANSACTION;
GO

DECLARE @var1 sysname;
SELECT @var1 = [d].[name]
FROM [sys].[default_constraints] [d]
INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
WHERE ([d].[parent_object_id] = OBJECT_ID(N'[Contrahents]') AND [c].[name] = N'VatInvoice');
IF @var1 IS NOT NULL EXEC(N'ALTER TABLE [Contrahents] DROP CONSTRAINT [' + @var1 + '];');
ALTER TABLE [Contrahents] DROP COLUMN [VatInvoice];
GO

ALTER TABLE [Contrahents] ADD [DefaultCurrencyCode] nvarchar(max) NULL;
GO

CREATE TABLE [ContrahentVatInvoice] (
    [Id] int NOT NULL IDENTITY,
    [ContrahentId] int NOT NULL,
    [VatInvoice] decimal(18,2) NOT NULL,
    CONSTRAINT [PK_ContrahentVatInvoice] PRIMARY KEY ([Id]),
    CONSTRAINT [FK_ContrahentVatInvoice_Contrahents_ContrahentId] FOREIGN KEY ([ContrahentId]) REFERENCES [Contrahents] ([Id]) ON DELETE CASCADE
);
GO

CREATE INDEX [IX_ContrahentVatInvoice_ContrahentId] ON [ContrahentVatInvoice] ([ContrahentId]);
GO

INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
VALUES (N'20230125200830_MultipleVatInvoicesPerContrahent', N'7.0.0');
GO

COMMIT;
GO

BEGIN TRANSACTION;
GO

DECLARE @var2 sysname;
SELECT @var2 = [d].[name]
FROM [sys].[default_constraints] [d]
INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
WHERE ([d].[parent_object_id] = OBJECT_ID(N'[Contrahents]') AND [c].[name] = N'Discount');
IF @var2 IS NOT NULL EXEC(N'ALTER TABLE [Contrahents] DROP CONSTRAINT [' + @var2 + '];');
ALTER TABLE [Contrahents] DROP COLUMN [Discount];
GO

CREATE TABLE [ContrahentDiscount] (
    [Id] int NOT NULL IDENTITY,
    [ContrahentId] int NOT NULL,
    [Discount] decimal(18,2) NOT NULL,
    CONSTRAINT [PK_ContrahentDiscount] PRIMARY KEY ([Id]),
    CONSTRAINT [FK_ContrahentDiscount_Contrahents_ContrahentId] FOREIGN KEY ([ContrahentId]) REFERENCES [Contrahents] ([Id]) ON DELETE CASCADE
);
GO

CREATE INDEX [IX_ContrahentDiscount_ContrahentId] ON [ContrahentDiscount] ([ContrahentId]);
GO

INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
VALUES (N'20230126150259_MultipleDiscountsPerContrahent', N'7.0.0');
GO

COMMIT;
GO

BEGIN TRANSACTION;
GO

ALTER TABLE [SalesDocuments] ADD [CurrencyCode] nvarchar(max) NOT NULL DEFAULT N'';
GO

INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
VALUES (N'20230126211034_AddCurrencyCodeColumnToSalesDocumentsTable', N'7.0.0');
GO

COMMIT;
GO

BEGIN TRANSACTION;
GO

DROP TABLE [BankAccount];
GO

CREATE TABLE [ContrahentBankAccount] (
    [Id] int NOT NULL IDENTITY,
    [ContrahentId] int NOT NULL,
    [Iban] nvarchar(max) NOT NULL,
    [BicCode] nvarchar(max) NOT NULL,
    [IsDefault] bit NOT NULL,
    CONSTRAINT [PK_ContrahentBankAccount] PRIMARY KEY ([Id]),
    CONSTRAINT [FK_ContrahentBankAccount_Contrahents_ContrahentId] FOREIGN KEY ([ContrahentId]) REFERENCES [Contrahents] ([Id]) ON DELETE CASCADE
);
GO

CREATE INDEX [IX_ContrahentBankAccount_ContrahentId] ON [ContrahentBankAccount] ([ContrahentId]);
GO

INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
VALUES (N'20230127153950_AddIsDefaultColumnToBankAccountTable', N'7.0.0');
GO

COMMIT;
GO

